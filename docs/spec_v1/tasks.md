# 实施计划 - 班级积分系统 V1

- [-] 1. 项目基础架构搭建
  - **可重用**: 现有的package.json、目录结构基本可用
  - **需修改**: 添加SQLite和Cloudflare相关依赖
  - **可重用**: 现有的存储适配器工厂模式，需扩展支持SQLite和D1
  - 创建Cloudflare部署的配置文件（wrangler.toml等）
  - _需求: 4_

- [ ] 2. 数据库层实现
  - [ ] 2.1 实现SQLite适配器
    - **新增**: 编写SQLite数据库连接和初始化代码
    - **可重用**: 参考现有jsonStorageAdapter的接口设计
    - **可重用**: 现有的错误处理机制
    - 编写SQLite适配器的单元测试
    - _需求: 4, 12_

  - [ ] 2.2 实现D1适配器
    - **新增**: 编写Cloudflare D1数据库适配器
    - **可重用**: 使用与现有适配器相同的接口设计
    - **新增**: 处理D1特有的异步操作和限制
    - 编写D1适配器的单元测试
    - _需求: 4, 12_

  - [ ] 2.3 创建数据库表结构
    - **新增**: 编写通用的SQL建表语句
    - **可重用**: 现有的数据初始化逻辑（utils/dataInitializer.js）
    - **可重用**: 现有的默认数据结构，转换为SQL插入语句
    - 测试数据库初始化流程
    - _需求: 4, 12_

- [ ] 3. 核心业务服务实现
  - [ ] 3.1 用户管理服务
    - **可重用**: 现有的StudentService基本完整，需适配新的数据库接口
    - **可重用**: 现有的TeacherService，需简化权限逻辑
    - **需修改**: 移除多班级相关的复杂权限验证
    - **可重用**: 现有的单元测试，需更新数据库适配器
    - _需求: 2, 6, 7_

  - [ ] 3.2 积分管理服务
    - **可重用**: 现有的PointsService功能完整，包含排行榜、缓存等优化
    - **需适配**: 更新为使用新的数据库适配器接口
    - **可重用**: 现有的积分清零、统计等功能
    - **可重用**: 现有的单元测试和性能优化代码
    - _需求: 5, 6, 7, 8_

  - [ ] 3.3 商品和预约管理服务
    - **可重用**: 现有的ProductService和OrderService基本功能
    - **需适配**: 更新为使用新的数据库适配器接口
    - **可重用**: 现有的库存管理和订单状态逻辑
    - **可重用**: 现有的单元测试
    - _需求: 9, 10_

  - [ ] 3.4 奖惩项管理服务
    - **新增**: 需要创建奖惩项管理服务（现有系统中缺少）
    - **可参考**: 现有的其他服务的代码结构和错误处理
    - **新增**: 实现快速积分操作逻辑
    - 编写奖惩项管理服务的单元测试
    - _需求: 3_

- [ ] 4. 系统状态管理实现
  - **可重用**: 现有的DisplayManager服务有部分状态管理功能
  - **需扩展**: 添加自动切换定时器功能
  - **需简化**: 移除多班级相关的复杂状态管理
  - **需适配**: 状态持久化到SQLite/D1数据库而非JSON文件
  - 编写系统状态管理的单元测试
  - _需求: 1, 11_

- [ ] 5. API接口层实现
  - [ ] 5.1 本地部署API（Express.js）
    - **可重用**: 现有的server.js和所有API路由文件（api/目录）
    - **需简化**: 移除多班级路由，只保留单班级API
    - **可重用**: 现有的错误处理中间件和性能监控
    - **可重用**: 现有的静态文件服务配置
    - **可重用**: 现有的集成测试，需更新数据库适配器
    - _需求: 1, 2, 3, 5, 6, 7, 8, 9, 10, 11_

  - [ ] 5.2 Cloudflare Workers API
    - **新增**: 创建Cloudflare Workers入口文件
    - **可重用**: 现有的API逻辑，需适配Workers运行时
    - **新增**: 处理Workers的请求/响应格式差异
    - **可重用**: 现有的业务逻辑和数据验证
    - 编写Workers API的集成测试
    - _需求: 1, 2, 3, 5, 6, 7, 8, 9, 10, 11_

- [ ] 6. 前端界面实现
  - [ ] 6.1 教室大屏界面
    - **可重用**: 现有的display/index.html基础结构
    - **需修改**: 简化路由，移除多班级相关代码
    - **可重用**: 现有的CSS样式和JavaScript逻辑
    - **需新增**: 上课模式界面和奖惩项按钮功能
    - **可重用**: 现有的实时数据更新机制（SSE）
    - **可重用**: 现有的端到端测试框架
    - _需求: 1, 3, 5, 6, 7, 10, 11_

  - [ ] 6.2 管理后台界面
    - **可重用**: 现有的teacher/index.html基础结构和导航
    - **可重用**: 现有的学生管理、积分管理页面
    - **可重用**: 现有的商品管理和预约管理页面
    - **需新增**: 奖惩项管理页面（现有系统中缺少）
    - **需简化**: 移除多班级相关的界面元素
    - **可重用**: 现有的端到端测试
    - _需求: 2, 3, 6, 8, 9, 10_

- [ ] 7. 部署配置和脚本
  - [ ] 7.1 本地部署配置
    - **可重用**: 现有的package.json启动脚本
    - **可重用**: 现有的备份服务（services/backupService.js）
    - **可重用**: 现有的Docker配置文件
    - **需修改**: 更新配置以支持SQLite数据库
    - **可重用**: 现有的部署文档，需更新数据库部分
    - _需求: 4, 12_

  - [ ] 7.2 Cloudflare部署配置
    - **新增**: 创建wrangler.toml配置文件
    - **新增**: 编写Cloudflare Pages构建脚本
    - **新增**: 创建D1数据库初始化脚本
    - **新增**: 编写Cloudflare部署文档
    - 测试Cloudflare部署流程
    - _需求: 4, 12_

- [ ] 8. 数据迁移和备份工具
  - **新增**: 编写SQLite到D1的数据迁移脚本
  - **新增**: 编写D1到SQLite的数据导出脚本
  - **可重用**: 现有的备份服务逻辑，需适配数据库存储
  - **可重用**: 现有的数据验证逻辑（models/dataModels.js）
  - **新增**: 编写JSON到SQLite/D1的迁移工具（从现有系统升级）
  - _需求: 12_

- [ ] 9. 系统集成测试
  - **可重用**: 现有的测试框架和测试用例（tests/目录）
  - **需扩展**: 添加SQLite和D1数据库的测试用例
  - **可重用**: 现有的性能测试和错误处理测试
  - **新增**: 测试两种部署方式的功能一致性
  - **可重用**: 现有的并发访问测试逻辑
  - _需求: 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12_

- [ ] 10. 文档和部署准备
  - **可重用**: 现有的README.md和文档结构
  - **需更新**: 更新用户手册以反映新的部署方式
  - **可重用**: 现有的演示数据和测试场景
  - **需扩展**: 添加SQLite和Cloudflare部署的故障排除指南
  - **可重用**: 现有的系统验证脚本
  - _需求: 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12_

## 代码重用总结

### 高度可重用的组件（80%以上代码可重用）
- **业务服务层**: PointsService, StudentService, ProductService, OrderService
- **API接口层**: 所有现有的API路由文件
- **前端界面**: 大屏和管理后台的基础结构
- **错误处理**: 中间件和错误处理机制
- **测试框架**: 现有的单元测试和集成测试

### 需要适配的组件（50-80%代码可重用）
- **存储适配器**: 现有的工厂模式，需扩展SQLite和D1支持
- **系统状态管理**: 现有的DisplayManager，需简化和扩展
- **部署配置**: 现有的Docker和启动脚本，需适配新数据库

### 需要新增的组件（20%以下代码可重用）
- **SQLite和D1适配器**: 全新实现
- **Cloudflare Workers**: 全新的运行时适配
- **奖惩项管理**: 现有系统缺少此功能
- **数据迁移工具**: 新的迁移需求

### 预估开发工作量
- **总体代码重用率**: 约70%
- **主要工作**: 数据库适配器实现、Cloudflare部署适配
- **次要工作**: 简化多班级逻辑、新增奖惩项功能
- **测试工作**: 更新现有测试、新增数据库测试